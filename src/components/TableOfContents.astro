---
interface Props {
  headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;
const filteredHeadings = headings.filter((h) => h.depth <= 3);
---

<nav class="toc-container">
  
  <details class="lg:hidden bg-white/40 border border-stone-200 rounded-lg p-4 mb-8">
    <summary class="font-sans font-bold cursor-pointer list-none flex justify-between items-center text-stone-600">
      <span>Table of Contents</span>
      <span class="text-xl">+</span>
    </summary>
    <ul class="mt-4 space-y-3">
      {filteredHeadings.map((heading) => (
        <li class={`text-sm ${heading.depth === 3 ? 'pl-4' : ''}`}>
          <a href={`#${heading.slug}`} class="toc-link mobile-link text-stone-600 block transition-colors">
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </details>

  <div class="hidden lg:block max-h-[80vh] overflow-y-auto overflow-x-hidden custom-scrollbar">
    <h2 class="font-sans text-xs font-bold uppercase tracking-widest text-stone-400 mb-6">
      On this page
    </h2>
    <ul class="space-y-1 border-l border-stone-200">
      {filteredHeadings.map((heading) => (
        <li>
          <a 
            href={`#${heading.slug}`} 
            class={`
              toc-link desktop-link block py-1 text-sm
              ${heading.depth === 3 ? 'pl-6' : 'pl-4'}
              border-l-2 border-transparent -ml-[3px]
              text-stone-500 hover:text-stone-900
              transition-colors duration-200
            `}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </div>

</nav>

<script is:inline>
  function initializeTOC() {
    const headers = document.querySelectorAll('article h2, article h3');
    let currentActiveId = null;
    let lastScrollY = window.pageYOffset;
    
    function setActiveLink(id) {
      if (currentActiveId === id) return;
      currentActiveId = id;
      
      // Reset all links to inactive state
      document.querySelectorAll('.toc-link').forEach((link) => {
        link.classList.remove('active-toc');
      });

      // Find all links (desktop & mobile) pointing to this header
      const activeLinks = document.querySelectorAll('.toc-link[href="#' + id + '"]');
      activeLinks.forEach((link) => {
        link.classList.add('active-toc');
      });
    }

    function updateActiveSection() {
      const scrollY = window.pageYOffset;
      const scrollDirection = scrollY > lastScrollY ? 'down' : 'up';
      lastScrollY = scrollY;
      
      const windowHeight = window.innerHeight;
      const docHeight = document.documentElement.scrollHeight;
      
      // Check if we're at the bottom
      if (scrollY + windowHeight >= docHeight - 10) {
        const lastHeader = headers[headers.length - 1];
        const lastId = lastHeader?.getAttribute('id');
        if (lastId) {
          setActiveLink(lastId);
          return;
        }
      }
      
      // Find which section is currently "active"
      let activeId = null;
      
      if (scrollDirection === 'down') {
        // When scrolling down, activate when header passes the top threshold
        const threshold = 150; // pixels from top
        for (let i = headers.length - 1; i >= 0; i--) {
          const header = headers[i];
          const rect = header.getBoundingClientRect();
          
          if (rect.top <= threshold) {
            activeId = header.getAttribute('id');
            break;
          }
        }
      } else {
        // When scrolling up, activate section whose header is above viewport
        // but activate it sooner (when header is still visible or just above)
        const threshold = 150; // More generous threshold for upward scrolling
        for (let i = headers.length - 1; i >= 0; i--) {
          const header = headers[i];
          const rect = header.getBoundingClientRect();
          
          // Activate if header is above the threshold or we're still in its content
          if (rect.top <= threshold) {
            activeId = header.getAttribute('id');
            break;
          }
        }
      }
      
      // If no section found and we're near the top, activate the first one
      if (!activeId && scrollY < 300 && headers.length > 0) {
        activeId = headers[0].getAttribute('id');
      }
      
      if (activeId) {
        setActiveLink(activeId);
      }
    }
    
    // Set initial active section
    updateActiveSection();
    
    // Update on scroll
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      // Use requestAnimationFrame for smooth updates
      if (scrollTimeout) {
        window.cancelAnimationFrame(scrollTimeout);
      }
      scrollTimeout = window.requestAnimationFrame(updateActiveSection);
    }, { passive: true });
  }

  // Initialize on both DOMContentLoaded and astro:page-load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeTOC);
  } else {
    initializeTOC();
  }
  
  // Also support Astro view transitions if enabled
  document.addEventListener('astro:page-load', initializeTOC);
</script>

<style>
  /* DEFINING THE ACTIVE STATE 
    We use a CSS class '.active-toc' controlled by the script above.
  */

  /* Desktop Active State */
  .desktop-link {
    transition: all 0.2s ease;
  }
  
  .desktop-link.active-toc {
    color: #000000 !important;
    /* Use text-shadow to simulate bold without changing width */
    text-shadow: 0 0 0.5px currentColor;
    letter-spacing: -0.01em;
    border-left-color: #333333 !important;
    transform: translateX(4px);
  }

  /* Mobile Active State */
  .mobile-link {
    transition: all 0.2s ease;
  }
  
  .mobile-link.active-toc {
    color: #000000 !important;
    text-shadow: 0 0 0.5px currentColor;
    letter-spacing: -0.01em;
    text-decoration: underline;
  }

  /* Scrollbar Aesthetics */
  .custom-scrollbar::-webkit-scrollbar { width: 4px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #e7e5e4; border-radius: 20px; }
</style>
</style>