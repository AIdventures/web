---
import { getCollection } from "astro:content";
import Footer from "../../components/Footer.astro";
import Search from "../../components/Search";
import PostCard from "../../components/PostCard.astro";
import "../../styles/global.css";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const tags = [...new Set(posts.flatMap(post => post.data.tags || []))];
  return tags.map(tag => ({ params: { tag }, props: { tag } }));
}

const { tag } = Astro.props;
const allPosts = await getCollection("posts");
const posts = allPosts
    .filter(post => post.data.tags?.includes(tag))
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <title>AIdventure - #{tag}</title>
        <meta name="description" content={`Explore all posts tagged with #${tag} on AIdventure.`} />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={Astro.url.href} />
        <meta property="og:title" content={`AIdventure - #${tag}`} />
        <meta property="og:description" content={`Explore all posts tagged with #${tag} on AIdventure.`} />
        <meta property="og:image" content="https://aidventure.es/og-image.png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content={Astro.url.href} />
        <meta name="twitter:title" content={`AIdventure - #${tag}`} />
        <meta name="twitter:description" content={`Explore all posts tagged with #${tag} on AIdventure.`} />
        <meta name="twitter:image" content="https://aidventure.es/og-image.png" />

        <!-- Umami Analytics -->
        <script defer src="https://cloud.umami.is/script.js" data-website-id="7d36b6d1-51b7-4dcc-aab8-5d9f5527974e"></script>
    </head>
    <body
        class="bg-bg text-primary min-h-screen p-6 md:p-12 max-w-3xl mx-auto flex flex-col"
    >
        <header
            class="relative mb-12 mt-4 sm:mt-10 flex flex-col sm:flex-row justify-between items-start gap-6"
        >
            <div class="pr-12 sm:pr-0">
                <a href="/" class="block">
                    <h1 class="font-serif text-3xl sm:text-4xl mb-2 hover:text-stone-600 transition-colors">AIdventure.</h1>
                </a>
                <p class="text-stone-500 font-sans text-lg">
                    Posts tagged with <span class="font-medium text-stone-800">#{tag}</span>
                </p>
            </div>
            <div
                class="absolute top-0 right-0 sm:static flex items-center gap-4"
            >
                <Search client:load />
                <div
                    class="hidden sm:flex items-center bg-stone-100 rounded-lg p-1 gap-1"
                >
                    <button
                        id="view-grid"
                        class="cursor-pointer p-1.5 rounded text-stone-400 hover:text-stone-800 hover:bg-white transition-all"
                        aria-label="Grid View"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            width="20"
                            height="20"
                            color="currentColor"
                            fill="none"
                        >
                            <path
                                d="M13 3H11C7.22876 3 5.34315 3 4.17157 4.17157C3 5.34315 3 7.22876 3 11V13C3 16.7712 3 18.6569 4.17157 19.8284C5.34315 21 7.22876 21 11 21H13C16.7712 21 18.6569 21 19.8284 19.8284C21 18.6569 21 16.7712 21 13V11C21 7.22876 21 5.34315 19.8284 4.17157C18.6569 3 16.7712 3 13 3Z"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"></path>
                            <path
                                d="M9 3V21"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"></path>
                            <path
                                d="M15 3V21"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"></path>
                            <path
                                d="M21.0001 9L3.00014 9"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"></path>
                            <path
                                d="M21.0001 15L3.00014 15"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"></path>
                        </svg>
                    </button>
                    <button
                        id="view-list"
                        class="cursor-pointer p-1.5 rounded text-stone-800 bg-white shadow-sm transition-all"
                        aria-label="List View"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 24 24"
                            width="20"
                            height="20"
                            color="currentColor"
                            fill="none"
                        >
                            <path
                                d="M10 5L20 5"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"></path>
                            <path
                                d="M4 12L20 12"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"></path>
                            <path
                                d="M4 19L14 19"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main
            id="posts-container"
            class="flex flex-col gap-8 sm:gap-12 flex-grow"
        >
            {
                posts.map((post, index) => (
                    <PostCard post={post} index={index} />
                ))
            }
        </main>

        <Footer />

        <script>
            const container = document.getElementById("posts-container");
            const gridBtn = document.getElementById("view-grid");
            const listBtn = document.getElementById("view-list");
            const articles = document.querySelectorAll(".post-article");
            const imageWrappers = document.querySelectorAll(
                ".post-image-wrapper",
            );
            const descriptions = document.querySelectorAll(
                ".post-content p:last-child",
            );

            // List View Classes
            const containerListClasses = [
                "flex",
                "flex-col",
            ];
            const containerGridClasses = [
                "grid",
                "grid-cols-1",
                "sm:grid-cols-2",
            ];

            const articleListClasses = ["flex-col", "sm:flex-row", "gap-6"];
            const articleGridClasses = ["flex-col", "gap-4", "h-full"];

            const imgListClasses = ["sm:w-48", "h-48", "sm:h-40"];
            const imgGridClasses = ["h-48"];

            function setView(view: string) {
                if (!container || !gridBtn || !listBtn) return;
                
                // If view is grid, or window width is smaller than 640px, set view to grid
                if (view === "grid" || window.innerWidth < 640) {
                    // Update Container
                    container.classList.remove(...containerListClasses);
                    container.classList.add(...containerGridClasses);

                    // Update Items
                    articles.forEach((article) => {
                        article.classList.remove(...articleListClasses);
                        article.classList.add(...articleGridClasses);
                    });
                    imageWrappers.forEach((wrapper) => {
                        wrapper.classList.remove(...imgListClasses);
                        wrapper.classList.add(...imgGridClasses);
                    });
                    descriptions.forEach((desc) => {
                        desc.classList.add("line-clamp-3");
                    });

                    // Update Buttons
                    gridBtn.classList.add(
                        "text-stone-800",
                        "bg-white",
                        "shadow-sm",
                    );
                    gridBtn.classList.remove(
                        "text-stone-400",
                        "hover:bg-white",
                    );

                    listBtn.classList.remove(
                        "text-stone-800",
                        "bg-white",
                        "shadow-sm",
                    );
                    listBtn.classList.add("text-stone-400", "hover:bg-white");
                } else {
                    // Update Container
                    container.classList.add(...containerListClasses);
                    container.classList.remove(...containerGridClasses);

                    // Update Items
                    articles.forEach((article) => {
                        article.classList.add(...articleListClasses);
                        article.classList.remove(...articleGridClasses);
                    });
                    imageWrappers.forEach((wrapper) => {
                        wrapper.classList.add(...imgListClasses);
                        wrapper.classList.remove(...imgGridClasses);
                    });
                    descriptions.forEach((desc) => {
                        desc.classList.remove("line-clamp-3");
                    });

                    // Update Buttons
                    listBtn.classList.add(
                        "text-stone-800",
                        "bg-white",
                        "shadow-sm",
                    );
                    listBtn.classList.remove(
                        "text-stone-400",
                        "hover:bg-white",
                    );

                    gridBtn.classList.remove(
                        "text-stone-800",
                        "bg-white",
                        "shadow-sm",
                    );
                    gridBtn.classList.add("text-stone-400", "hover:bg-white");
                }
            }

            // Initialize
            const savedView = localStorage.getItem("posts-view") || "list";
            setView(savedView);

            gridBtn?.addEventListener("click", () => {
                setView("grid");
                localStorage.setItem("posts-view", "grid");
            });

            listBtn?.addEventListener("click", () => {
                setView("list");
                localStorage.setItem("posts-view", "list");
            });

            window.addEventListener("resize", () => {
                const savedView = localStorage.getItem("posts-view") || "list";
                setView(savedView);
            });
        </script>
    </body>
</html>
